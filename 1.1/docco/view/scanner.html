<!DOCTYPE html>

<html>
<head>
  <title>scanner.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="elements.html">
                elements.js
              </a>
            
              
              <a class="source" href="live.html">
                live.js
              </a>
            
              
              <a class="source" href="node_lists.html">
                node_lists.js
              </a>
            
              
              <a class="source" href="render.html">
                render.js
              </a>
            
              
              <a class="source" href="scanner.html">
                scanner.js
              </a>
            
              
              <a class="source" href="view.html">
                view.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>scanner.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>steal(<span class="hljs-string">'can/view'</span>, <span class="hljs-string">'./elements'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(can, elements)</span></span>{

<span class="hljs-comment">/**
 * Helper(s)
 */</span>
<span class="hljs-keyword">var</span> newLine = <span class="hljs-regexp">/(\r|\n)+/g</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Escapes characters starting with <code>\</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	clean = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( content )</span> </span>{
		<span class="hljs-keyword">return</span> content
			.split(<span class="hljs-string">'\\'</span>).join(<span class="hljs-string">"\\\\"</span>)
			.split(<span class="hljs-string">"\n"</span>).join(<span class="hljs-string">"\\n"</span>)
			.split(<span class="hljs-string">'"'</span>).join(<span class="hljs-string">'\\"'</span>)
			.split(<span class="hljs-string">"\t"</span>).join(<span class="hljs-string">"\\t"</span>);
	},</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Returns a tagName to use as a temporary placeholder for live content
looks forward … could be slow, but we only do it when necessary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	getTag = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tagName, tokens, i)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if a tagName is provided, use that</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(tagName){
			<span class="hljs-keyword">return</span> tagName;  
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>otherwise go searching for the next two tokens like “&lt;”,TAG</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">while</span>(i &lt; tokens.length){
				<span class="hljs-keyword">if</span>(tokens[i] == <span class="hljs-string">"&lt;"</span> &amp;&amp; elements.reverseTagMap[tokens[i+<span class="hljs-number">1</span>]]){
					<span class="hljs-keyword">return</span> elements.reverseTagMap[tokens[i+<span class="hljs-number">1</span>]];
				}
				i++;
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
	},
	bracketNum = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(content)</span></span>{
		<span class="hljs-keyword">return</span> (--content.split(<span class="hljs-string">"{"</span>).length) - (--content.split(<span class="hljs-string">"}"</span>).length);
	},
	 myEval = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( script )</span> </span>{
		<span class="hljs-built_in">eval</span>(script);
	},
	attrReg = <span class="hljs-regexp">/([^\s]+)[\s]*=[\s]*$/</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Commands for caching.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	startTxt = <span class="hljs-string">'var ___v1ew = [];'</span>,
	finishTxt = <span class="hljs-string">"return ___v1ew.join('')"</span>,
	put_cmd = <span class="hljs-string">"___v1ew.push("</span>,
	insert_cmd = put_cmd,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Global controls (used by other functions to know where we are).
Are we inside a tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	htmlTag = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Are we within a quote within a tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	quote = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>What was the text before the current quote? (used to get the <code>attr</code> name)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	beforeQuote = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Whether a rescan is in progress</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rescan = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Used to mark where the element is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	status = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>t</code> - <code>1</code>.
<code>h</code> - <code>0</code>.
<code>q</code> - String <code>beforeQuote</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> quote ? <span class="hljs-string">"'"</span>+beforeQuote.match(attrReg)[<span class="hljs-number">1</span>]+<span class="hljs-string">"'"</span> : (htmlTag ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);
	};

can.view.Scanner = Scanner = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( options )</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Set options on self</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  can.extend(<span class="hljs-keyword">this</span>, {
		text: {},
  	tokens: []
  }, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Cache a token lookup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.tokenReg = [];
	<span class="hljs-keyword">this</span>.tokenSimple = { <span class="hljs-string">"&lt;"</span>: <span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"&gt;"</span>: <span class="hljs-string">"&gt;"</span>, <span class="hljs-string">'"'</span>: <span class="hljs-string">'"'</span>, <span class="hljs-string">"'"</span>: <span class="hljs-string">"'"</span> };
	<span class="hljs-keyword">this</span>.tokenComplex = [];
	<span class="hljs-keyword">this</span>.tokenMap = {};
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, token; token = <span class="hljs-keyword">this</span>.tokens[i]; i++) {
		<span class="hljs-comment">/**
		 * Token data structure (complex token and rescan function are optional):
		 * [
		 *	"token name",
		 *	"simple token or abbreviation",
		 *	/complex token regexp/,
		 *	function(content) {
		 *		// Rescan Function
		 *		return {
		 *			before: '\n',
		 *			content: content.trim(),
		 *			after: '\n'
		 *		}
		 * ]
		 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Save complex mappings (custom regexp)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (token[<span class="hljs-number">2</span>]) {
			<span class="hljs-keyword">this</span>.tokenReg.push(token[<span class="hljs-number">2</span>]);
			<span class="hljs-keyword">this</span>.tokenComplex.push({ abbr: token[<span class="hljs-number">1</span>], re: <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(token[<span class="hljs-number">2</span>]), rescan: token[<span class="hljs-number">3</span>] });
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Save simple mappings (string only, no regexp)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">this</span>.tokenReg.push(token[<span class="hljs-number">1</span>]);
			<span class="hljs-keyword">this</span>.tokenSimple[token[<span class="hljs-number">1</span>]] = token[<span class="hljs-number">0</span>];
		}
		<span class="hljs-keyword">this</span>.tokenMap[token[<span class="hljs-number">0</span>]] = token[<span class="hljs-number">1</span>];
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Cache the token registry.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">this</span>.tokenReg = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">"("</span> + <span class="hljs-keyword">this</span>.tokenReg.slice(<span class="hljs-number">0</span>).concat([<span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"&gt;"</span>, <span class="hljs-string">'"'</span>, <span class="hljs-string">"'"</span>]).join(<span class="hljs-string">"|"</span>) + <span class="hljs-string">")"</span>,<span class="hljs-string">"g"</span>);
};

<span class="hljs-comment">/**
 * Extend can.View to add scanner support.
 */</span>
Scanner.prototype = {

	helpers: [
		<span class="hljs-comment">/**
		 * Check if its a func like `()-&gt;`.
		 * @param {String} content
		 */</span>
		{
			name:<span class="hljs-regexp">/\s*\(([\$\w]+)\)\s*-&gt;([^\n]*)/</span>,
			fn: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(content)</span></span>{
				<span class="hljs-keyword">var</span> quickFunc = <span class="hljs-regexp">/\s*\(([\$\w]+)\)\s*-&gt;([^\n]*)/</span>,
					parts = content.match(quickFunc);

				<span class="hljs-keyword">return</span> <span class="hljs-string">"can.proxy(function(__){var "</span> + parts[<span class="hljs-number">1</span>] + <span class="hljs-string">"=can.$(__);"</span> + parts[<span class="hljs-number">2</span>] + <span class="hljs-string">"}, this);"</span>;
			}
		}
	],

	scan: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(source, name)</span></span>{
		<span class="hljs-keyword">var</span> tokens = [],
			last = <span class="hljs-number">0</span>,
			simple = <span class="hljs-keyword">this</span>.tokenSimple,
			complex = <span class="hljs-keyword">this</span>.tokenComplex;
		
		source = source.replace(newLine, <span class="hljs-string">"\n"</span>);
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.transform) {
			source = <span class="hljs-keyword">this</span>.transform(source);
		}
		source.replace(<span class="hljs-keyword">this</span>.tokenReg, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(whole, part)</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>offset is the second to last argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> offset = <span class="hljs-built_in">arguments</span>[<span class="hljs-built_in">arguments</span>.length-<span class="hljs-number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>if the next token starts after the last token ends
push what’s in between</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span>(offset &gt; last){
				tokens.push( source.substring(last, offset) );
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>push the simple token (if there is one)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (simple[whole]) {
				tokens.push(whole);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>otherwise lookup complex tokens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, token; token = complex[i]; i++) {
					<span class="hljs-keyword">if</span> (token.re.test(whole)) {
						tokens.push(token.abbr);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Push a rescan function if one exists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (token.rescan) {
							tokens.push(token.rescan(part));
						}
						<span class="hljs-keyword">break</span>;
					}
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>update the position of the last part of the last token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			last = offset+part.length;
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>if there’s something at the end, add it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(last &lt; source.length){
			tokens.push(source.substr(last));
		}
		
		<span class="hljs-keyword">var</span> content = <span class="hljs-string">''</span>,
			buff = [startTxt + (<span class="hljs-keyword">this</span>.text.start || <span class="hljs-string">''</span>)],</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Helper <code>function</code> for putting stuff in the view concat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			put = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( content, bonus )</span> </span>{
				buff.push(put_cmd, <span class="hljs-string">'"'</span>, clean(content), <span class="hljs-string">'"'</span>+(bonus||<span class="hljs-string">''</span>)+<span class="hljs-string">');'</span>);
			},</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>A stack used to keep track of how we should end a bracket
<code>}</code>.<br>Once we have a <code>&lt;%= %&gt;</code> with a <code>leftBracket</code>,
we store how the file should end here (either <code>))</code> or <code>;</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			endStack =[],</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>The last token, used to remember which tag we are in.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			lastToken,</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The corresponding magic tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			startTag = <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Was there a magic tag inside an html tag?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			magicInTag = <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The current tag name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			tagName = <span class="hljs-string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>stack of tagNames</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			tagNames = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Pop from tagNames?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			popTagName = <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Declared here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			bracketCount,
			i = <span class="hljs-number">0</span>,
			token,
			tmap = <span class="hljs-keyword">this</span>.tokenMap;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Reinitialize the tag state goodness.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		htmlTag = quote = beforeQuote = <span class="hljs-literal">null</span>;

		<span class="hljs-keyword">for</span> (; (token = tokens[i++]) !== <span class="hljs-literal">undefined</span>;) {
			<span class="hljs-keyword">if</span> ( startTag === <span class="hljs-literal">null</span> ) {
				<span class="hljs-keyword">switch</span> ( token ) {
				<span class="hljs-keyword">case</span> tmap.left:
				<span class="hljs-keyword">case</span> tmap.escapeLeft:
				<span class="hljs-keyword">case</span> tmap.returnLeft:
					magicInTag = htmlTag &amp;&amp; <span class="hljs-number">1</span>;
				<span class="hljs-keyword">case</span> tmap.commentLeft:</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>A new line — just add whatever content within a clean.<br>Reset everything.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					startTag = token;
					<span class="hljs-keyword">if</span> ( content.length ) {
						put(content);
					}
					content = <span class="hljs-string">''</span>;
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> tmap.escapeFull:</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>This is a full line escape (a line that contains only whitespace and escaped logic)
Break it up into escape left and right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					magicInTag = htmlTag &amp;&amp; <span class="hljs-number">1</span>;
					rescan = <span class="hljs-number">1</span>;
					startTag = tmap.escapeLeft;
					<span class="hljs-keyword">if</span> ( content.length ) {
						put(content);
					}
					rescan = tokens[i++];
					content = rescan.content || rescan;
					<span class="hljs-keyword">if</span> ( rescan.before ) {
						put(rescan.before);
					}
					tokens.splice(i, <span class="hljs-number">0</span>, tmap.right);
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> tmap.commentFull:</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Ignore full line comments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> tmap.templateLeft:
					content += tmap.left;
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> <span class="hljs-string">'&lt;'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Make sure we are not in a comment.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(tokens[i].indexOf(<span class="hljs-string">"!--"</span>) !== <span class="hljs-number">0</span>) {
						htmlTag = <span class="hljs-number">1</span>;
						magicInTag = <span class="hljs-number">0</span>;
					}
					content += token;
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> <span class="hljs-string">'&gt;'</span>:
					htmlTag = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>content.substr(-1) doesn’t work in IE7/8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> emptyElement = content.substr(content.length-<span class="hljs-number">1</span>) == <span class="hljs-string">"/"</span> || content.substr(content.length-<span class="hljs-number">2</span>) == <span class="hljs-string">"--"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>if there was a magic tag
or it’s an element that has text content between its tags, 
but content is not other tags add a hookup
TODO: we should only add <code>can.EJS.pending()</code> if there’s a magic tag 
within the html tags.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(magicInTag || !popTagName &amp;&amp; elements.tagToContentPropMap[ tagNames[tagNames.length -<span class="hljs-number">1</span>] ]){</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>make sure / of /&gt; is on the left of pending</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span>(emptyElement){
							put(content.substr(<span class="hljs-number">0</span>,content.length-<span class="hljs-number">1</span>), <span class="hljs-string">",can.view.pending(),\"/&gt;\""</span>);
						} <span class="hljs-keyword">else</span> {
							put(content, <span class="hljs-string">",can.view.pending(),\"&gt;\""</span>);
						}
						content = <span class="hljs-string">''</span>;
						magicInTag = <span class="hljs-number">0</span>;
					} <span class="hljs-keyword">else</span> {
						content += token;
					}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>if it’s a tag like <input/></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(emptyElement || popTagName){</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>remove the current tag in the stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						tagNames.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>set the current tag to the previous parent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						tagName = tagNames[tagNames.length-<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Don’t pop next time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						popTagName = <span class="hljs-literal">false</span>;
					}
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> <span class="hljs-string">"'"</span>:
				<span class="hljs-keyword">case</span> <span class="hljs-string">'"'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>If we are in an html tag, finding matching quotes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(htmlTag){</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>We have a quote and it matches.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span>(quote &amp;&amp; quote === token){</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>We are exiting the quote.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							quote = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Otherwise we are creating a quote.
TODO: does this handle <code>\</code>?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(quote === <span class="hljs-literal">null</span>){
							quote = token;
							beforeQuote = lastToken;
						}
					}
				<span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Track the current tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>(lastToken === <span class="hljs-string">'&lt;'</span>){
						tagName = token.split(<span class="hljs-regexp">/\s/</span>)[<span class="hljs-number">0</span>];
						<span class="hljs-keyword">if</span>( tagName.indexOf(<span class="hljs-string">"/"</span>) === <span class="hljs-number">0</span> &amp;&amp; tagNames[tagNames.length-<span class="hljs-number">1</span>] === tagName.substr(<span class="hljs-number">1</span>) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>set tagName to the last tagName
if there are no more tagNames, we’ll rely on getTag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							tagName = tagNames[tagNames.length-<span class="hljs-number">1</span>];
							popTagName = <span class="hljs-literal">true</span>;
						} <span class="hljs-keyword">else</span> {
							tagNames.push(tagName);
						}
					}
					content += token;
					<span class="hljs-keyword">break</span>;
				}
			} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>We have a start tag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">switch</span> ( token ) {
				<span class="hljs-keyword">case</span> tmap.right:
				<span class="hljs-keyword">case</span> tmap.returnRight:
					<span class="hljs-keyword">switch</span> ( startTag ) {
					<span class="hljs-keyword">case</span> tmap.left:</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Get the number of <code>{ minus }</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						bracketCount = bracketNum(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>We are ending a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (bracketCount == <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>We are starting on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							buff.push(insert_cmd, <span class="hljs-string">"can.view.txt(0,'"</span>+getTag(tagName,tokens, i)+<span class="hljs-string">"',"</span> + status() + <span class="hljs-string">",this,function(){"</span>, startTxt, content);

							endStack.push({
								before: <span class="hljs-string">""</span>,
								after: finishTxt+<span class="hljs-string">"}));\n"</span>
							});
						}
						<span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>How are we ending this statement?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							last = <span class="hljs-comment">// If the stack has value and we are ending a block...</span>
								endStack.length &amp;&amp; bracketCount == -<span class="hljs-number">1</span> ? <span class="hljs-comment">// Use the last item in the block stack.</span>
								endStack.pop() : <span class="hljs-comment">// Or use the default ending.</span>
							{
								after: <span class="hljs-string">";"</span>
							};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>If we are ending a returning block, 
add the finish text which returns the result of the
block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							<span class="hljs-keyword">if</span> (last.before) {
								buff.push(last.before);
							}</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Add the remaining content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							buff.push(content, <span class="hljs-string">";"</span>,last.after);
						}
						<span class="hljs-keyword">break</span>;
					<span class="hljs-keyword">case</span> tmap.escapeLeft:
					<span class="hljs-keyword">case</span> tmap.returnLeft:</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>We have an extra <code>{</code> -&gt; <code>block</code>.
Get the number of <code>{ minus }</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						bracketCount = bracketNum(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If we have more <code>{</code>, it means there is a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span>( bracketCount ){</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>When we return to the same # of <code>{</code> vs <code>}</code> end with a <code>doubleParent</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							endStack.push({
								before : finishTxt,
								after: <span class="hljs-string">"}));"</span>
							});
						} 

						<span class="hljs-keyword">var</span> escaped = startTag === tmap.escapeLeft ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,
							commands = { insert: insert_cmd, tagName: getTag(tagName, tokens, i), status: status() };

						<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> ii = <span class="hljs-number">0</span>; ii &lt; <span class="hljs-keyword">this</span>.helpers.length;ii++){</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Match the helper based on helper
regex name value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							<span class="hljs-keyword">var</span> helper = <span class="hljs-keyword">this</span>.helpers[ii];
							<span class="hljs-keyword">if</span>(helper.name.test(content)){
								content = helper.fn(content, commands);</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>dont escape partials</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>								<span class="hljs-keyword">if</span>(helper.name.source == <span class="hljs-regexp">/^&gt;[\s]*\w*/</span>.source){
									escaped = <span class="hljs-number">0</span>;
								}	
								<span class="hljs-keyword">break</span>;
							}
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Handle special cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> content == <span class="hljs-string">'object'</span>) {
							<span class="hljs-keyword">if</span> (content.raw) {
								buff.push(content.raw);
							}
						} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>If we have <code>&lt;%== a(function(){ %&gt;</code> then we want
<code>can.EJS.text(0,this, function(){ return a(function(){ var _v1ew = [];</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							buff.push(insert_cmd, <span class="hljs-string">"can.view.txt("</span> + escaped + <span class="hljs-string">",'"</span>+tagName+<span class="hljs-string">"',"</span> + status() +<span class="hljs-string">",this,function(){ "</span> + (<span class="hljs-keyword">this</span>.text.escape || <span class="hljs-string">''</span>) + <span class="hljs-string">"return "</span>, content,</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>If we have a block.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>								bracketCount ?</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Start with startTxt <code>&quot;var _v1ew = [];&quot;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>								startTxt :</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If not, add <code>doubleParent</code> to close push and text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>								<span class="hljs-string">"}));"</span>
								);
						}
						
						<span class="hljs-keyword">if</span> (rescan &amp;&amp; rescan.after &amp;&amp; rescan.after.length) {
							put(rescan.after.length);
							rescan = <span class="hljs-literal">null</span>;
						}
						<span class="hljs-keyword">break</span>;
					}
					startTag = <span class="hljs-literal">null</span>;
					content = <span class="hljs-string">''</span>;
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">case</span> tmap.templateLeft:
					content += tmap.left;
					<span class="hljs-keyword">break</span>;
				<span class="hljs-keyword">default</span>:
					content += token;
					<span class="hljs-keyword">break</span>;
				}
			}
			lastToken = token;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Put it together…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> ( content.length ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Should be <code>content.dump</code> in Ruby.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			put(content);
		}
		buff.push(<span class="hljs-string">";"</span>);
		
		<span class="hljs-keyword">var</span> template = buff.join(<span class="hljs-string">''</span>),
			out = {
				out: <span class="hljs-string">'with(_VIEW) { with (_CONTEXT) {'</span> + template + <span class="hljs-string">" "</span>+finishTxt+<span class="hljs-string">"}}"</span>
			};</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Use <code>eval</code> instead of creating a function, because it is easier to debug.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		myEval.call(out, <span class="hljs-string">'this.fn = (function(_CONTEXT,_VIEW){'</span> + out.out + <span class="hljs-string">'});\r\n//@ sourceURL='</span> + name + <span class="hljs-string">".js"</span>);

		<span class="hljs-keyword">return</span> out;
	}
};

<span class="hljs-keyword">return</span> Scanner;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
